version: '3'

env:
  GO_MODULE: github.com/twipi/twipi

  PORT: 8080
  DISCORD_PORT: 8090

  PHONE_NUMBER: +19876543210
  WSBRIDGE_URL: ws://localhost:8080/sms/ws

includes:
  proto:
    taskfile: proto/Taskfile.yml
    dir: proto

tasks:
  dev:
    deps: [generate]
    cmds:
      - go run ./cmd/twid -vvv -c ./twid.json

  generate:
    deps:
      - proto:compile
      - sqlc
      - build-config

  sqlc:
    cmds:
      - sqlc generate

  build-config:
    generates:
      - twid.json
    cmds:
      - |
        nix-instantiate \
          --eval --strict --json \
          --argstr port "$PORT" \
          --argstr discordPort "$DISCORD_PORT" \
          --argstr phoneNumber "$PHONE_NUMBER" \
          ./twid.cfg.nix > twid.json

  wsbridge-client:
    cmds:
      - go run ./cmd/wsbridge-client -u "$WSBRIDGE_URL" "$PHONE_NUMBER"
